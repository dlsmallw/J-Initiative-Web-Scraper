<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: backend/services/label-studio-api.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: backend/services/label-studio-api.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * API for interacting with a linked label studio organization project.
 */

const axios = require('axios').default;

var APITOKEN = '';
var BASEURL = '';

const RequestType = {
    GetProjects: {
        id: 0,
        name: 'GetProjects',
        successMsg: 'Project List Successfully Retrieved from Label Studio',
        failMsg: 'Failed to Retrieve Project List from Label Studio'
    },
    ExportTasks: {
        id: 1,
        name: 'ExportTasks',
        successMsg: 'Data Successfully Exported to Label Studio',
        failMsg: 'Error Exporting Scraped Data to Label Studio'
    }
}

/**
 * Generates a request header for making requests to a specified Label Studio project.
 * @returns JSON        The request header.
 */
function requestHeader() {
    return {
        'Content-Type': 'application/json',
        'Authorization': `Token ${APITOKEN}`
    }
}

/**
 * Formats the returned project information into a JSON object.
 * @param {*} response          The response object.
 * @returns                     A JSON object of the project info.
 */
function formatProjectData(response) {
    var numProjects = response.count;
    var results = response.results;
    var formattedResults = [];
    var index = numProjects - 1;

    results.forEach(project => {
        formattedResults[index] = {
            id: project.id,
            project_name: project.title
        };

        index -= 1;
    });

    return formattedResults;
}

/**
 * Handles the logic for making a project request api call to the linked LS project.
 * @returns             The response of the API call.
 */
function getProjects() {
    var request = {
        method: 'get',
        url: `${BASEURL}/api/projects`,
        headers: requestHeader()
    }

    return makeRequestToLS(request, RequestType.GetProjects);
}

/**
 * Handles making any number of LS API calls.
 * @param {*} requestJSON       The request object.
 * @param {*} requestType       The type of request.
 * @returns                     The response.
 */
function makeRequestToLS(requestJSON, requestType) {
    // Used to define an informative response to be sent back to the renderer
    let jsonOBJ = {
        ok: null,
        requestType: requestType.name,
        data: null,
        resMsg: null,
        errType: null
    }

    return new Promise((resolve) => {
        if (APITOKEN === '' || BASEURL === '') {
            jsonOBJ.ok = false;
            jsonOBJ.resMsg = requestType.failMsg;
            jsonOBJ.errType = 'Token/URL Missing';

            resolve(jsonOBJ);
        } else {
            axios(requestJSON).then(function(res) {
                var status = res.status;
                var statusText = res.statusText;
    
                if (status >= 200 &amp;&amp; status &lt; 300) {
                    jsonOBJ.ok = true;
                    jsonOBJ.resMsg = requestType.successMsg;
                    jsonOBJ.errType = 'NONE';

                    if (requestType === RequestType.GetProjects) {
                        jsonOBJ.data = formatProjectData(res.data);
                    }
                } else {
                    jsonOBJ.ok = false;
                    jsonOBJ.resMsg = requestType.failMsg;
                    jsonOBJ.errType = statusText;
                }
    
                resolve(jsonOBJ);
            }).catch(err => {
                jsonOBJ.ok = false;
                jsonOBJ.errType = 'Request Failure';
                jsonOBJ.resMsg = 'Error Encountered Making Request to Label Studio Project';
    
                resolve(jsonOBJ);
            });
        }
    });
}

/**
 * Formats raw string data by splitting it into an array of individual sentences.
 * @param {*} textData       The data to be formatted.
 * @returns Array           An array split into individual sentences.
 */
function formatTextData(textData) {
    var regex = /(?:\([^()]*\)|\d+\.\d+|[^.?!])+[.?!]/g;
    // can be used to check for ascii valid characters but this may not be what we want
    // var asciiRegex = /^[\x00-\x7F]+$/;       

    var trimmedRawData = textData.trim();
    
    if (trimmedRawData &amp;&amp; trimmedRawData !== '') {
        var formattedData = [];
        var sentArr = trimmedRawData.match(regex);

        if (sentArr &amp;&amp; sentArr.length > 0) {
            sentArr.forEach(sent => {
                var sentStr = sent.trim();

                if (sentStr !== '') {
                    formattedData.push({
                        text: sentStr
                    });
                }
            });
        } else {
            formattedData.push({
                text: trimmedRawData
            });
        }

        return formattedData;
    }

    return null;
}

/**
 * Processes the raw data received from the application into a format acceptable for Label Studio.
 * @param {*} dataArr       The raw data.
 * @returns                 A formatted array of all data to export.
 */
function formatDataArr(dataArr) {
    var formattedResult = null;

    if (dataArr !== null) {
        var formattedArr = [];

        for (var i = 0; i &lt; dataArr.length; i++) {
            var data = formatTextData(dataArr[i].textData);

            for (var j = 0; j &lt; data.length; j++) {
                formattedArr.push(data[j]);
            }
        }

        if (formattedArr.length !== 0) {
            formattedResult = formattedArr;
        }
    }

    return formattedResult;
}

/**
 * Generates a JSON request object for exporting data to Label Studio.
 * @param {*} rawData       The data to be exported.
 * @returns JSON            The request object.
 */
function requestJSON(rawData, projectID) {
    var formattedData = formatDataArr(rawData);

    if (formattedData !== null) {
        return {
            method: 'post',
            url: `${BASEURL}/api/projects/${projectID}/import`,
            headers: requestHeader(),
            data: formattedData
        }
    } else {
        throw new Error("Invalid Data Format From Null Data.");
    }
}

/**
* Makes a post request to export data to the linked LS project.
 * @param {*} rawData       The data to be exported.
 * @param {*} projectID     The ID of the project to export to.
 * @returns JSON            Object indicating success or failure.
 */
function exportDataToLS(rawData, projectID) {
    try {
        var request = requestJSON(rawData, projectID);

        return makeRequestToLS(request, RequestType.ExportTasks);
    } catch (err) {
        return new Promise(resolve => {
            resolve({
                ok: false,
                requestType: RequestType.ExportTasks,
                resMsg: RequestType.ExportTasks.failMsg,
                errType: err
            });
        });  
    }
}

/**
 * Handles updating the LS URL.
 * @param {*} url       The new URL.
 */
function updateLinkedLSProject(url) {
    BASEURL = url;
    APITOKEN = '';
}

/**
 * Handles updating the API token.
 * @param {*} token         The new token.
 * @returns                 The updated list of projects.
 */
function updateAPIToken(token) {
    APITOKEN = token;
    return getProjects();
}

/**
 * Clears the linked LS project.
 */
function clearLinkedLSProject() {
    BASEURL = '';
    APITOKEN = '';

    return {
        ok: true,
        data: null
    }
}

module.exports= { exportDataToLS, updateLinkedLSProject, updateAPIToken, clearLinkedLSProject };</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Sanitizer.html">Sanitizer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addDataToDatabase">addDataToDatabase</a></li><li><a href="global.html#appendNewScrapedItem">appendNewScrapedItem</a></li><li><a href="global.html#axios">axios</a></li><li><a href="global.html#checkAncestorSelected">checkAncestorSelected</a></li><li><a href="global.html#checkIfAnyActive">checkIfAnyActive</a></li><li><a href="global.html#clearLinkedLSProject">clearLinkedLSProject</a></li><li><a href="global.html#clearLogUpdateInterval">clearLogUpdateInterval</a></li><li><a href="global.html#clearScrapedList">clearScrapedList</a></li><li><a href="global.html#clearTextSelection">clearTextSelection</a></li><li><a href="global.html#closeAllWindows">closeAllWindows</a></li><li><a href="global.html#closeLSWindow">closeLSWindow</a></li><li><a href="global.html#closeScrapeWindow">closeScrapeWindow</a></li><li><a href="global.html#combineSelToResObj">combineSelToResObj</a></li><li><a href="global.html#createLSExternal">createLSExternal</a></li><li><a href="global.html#createMainWindow">createMainWindow</a></li><li><a href="global.html#createURLWindow">createURLWindow</a></li><li><a href="global.html#deselectAllElements">deselectAllElements</a></li><li><a href="global.html#deselectElement">deselectElement</a></li><li><a href="global.html#disableAutoImportBtns">disableAutoImportBtns</a></li><li><a href="global.html#disableManImportBtn">disableManImportBtn</a></li><li><a href="global.html#disableModeSelector">disableModeSelector</a></li><li><a href="global.html#disableWebview">disableWebview</a></li><li><a href="global.html#enableAutoImportBtns">enableAutoImportBtns</a></li><li><a href="global.html#enableManImportBtn">enableManImportBtn</a></li><li><a href="global.html#enableModeSelector">enableModeSelector</a></li><li><a href="global.html#enableWebview">enableWebview</a></li><li><a href="global.html#exportDataToApp">exportDataToApp</a></li><li><a href="global.html#exportDataToLS">exportDataToLS</a></li><li><a href="global.html#formIndivDataResObj">formIndivDataResObj</a></li><li><a href="global.html#formLogObject">formLogObject</a></li><li><a href="global.html#formatDataArr">formatDataArr</a></li><li><a href="global.html#formatProjectData">formatProjectData</a></li><li><a href="global.html#formatTextData">formatTextData</a></li><li><a href="global.html#getAllReadyData">getAllReadyData</a></li><li><a href="global.html#getProjects">getProjects</a></li><li><a href="global.html#getSelectedText">getSelectedText</a></li><li><a href="global.html#hotKeySettingChanging">hotKeySettingChanging</a></li><li><a href="global.html#hotKeySettingNormal">hotKeySettingNormal</a></li><li><a href="global.html#hotkeyChangeRequested">hotkeyChangeRequested</a></li><li><a href="global.html#hoveredElement">hoveredElement</a></li><li><a href="global.html#indivSelToResObj">indivSelToResObj</a></li><li><a href="global.html#initDataContainer">initDataContainer</a></li><li><a href="global.html#initKeyMouseEventListeners">initKeyMouseEventListeners</a></li><li><a href="global.html#initLogListener">initLogListener</a></li><li><a href="global.html#initScrapeUtilListeners">initScrapeUtilListeners</a></li><li><a href="global.html#initScrapeWindow">initScrapeWindow</a></li><li><a href="global.html#initTheme">initTheme</a></li><li><a href="global.html#initWinListeners">initWinListeners</a></li><li><a href="global.html#logDebug">logDebug</a></li><li><a href="global.html#logError">logError</a></li><li><a href="global.html#logInfo">logInfo</a></li><li><a href="global.html#logWarn">logWarn</a></li><li><a href="global.html#makeLog">makeLog</a></li><li><a href="global.html#makeRequestToLS">makeRequestToLS</a></li><li><a href="global.html#manualTextScrape">manualTextScrape</a></li><li><a href="global.html#processSelectedElems">processSelectedElems</a></li><li><a href="global.html#releaseHoveredElement">releaseHoveredElement</a></li><li><a href="global.html#removeSelectedItems">removeSelectedItems</a></li><li><a href="global.html#requestHeader">requestHeader</a></li><li><a href="global.html#requestJSON">requestJSON</a></li><li><a href="global.html#selectElement">selectElement</a></li><li><a href="global.html#selectedElementsCheck">selectedElementsCheck</a></li><li><a href="global.html#selectedTextCheck">selectedTextCheck</a></li><li><a href="global.html#sendNewLogsToRenderer">sendNewLogsToRenderer</a></li><li><a href="global.html#setHotKey">setHotKey</a></li><li><a href="global.html#startLoggingInterval">startLoggingInterval</a></li><li><a href="global.html#terminateApp">terminateApp</a></li><li><a href="global.html#terminateLogListener">terminateLogListener</a></li><li><a href="global.html#updateAPIToken">updateAPIToken</a></li><li><a href="global.html#updateLinkedLSProject">updateLinkedLSProject</a></li><li><a href="global.html#writeNewLog">writeNewLog</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Sat Mar 22 2025 08:06:57 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
